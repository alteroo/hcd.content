<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    lang="en"
    metal:use-macro="context/main_template/macros/master"
    i18n:domain="hcd.content">
<body>


<metal:content-core fill-slot="content-core">
<metal:content-core define-macro="content-core"
                    tal:define="toc context/table_of_contents|nothing;">

<?python
from plone import api
portal = api.portal.get()
?>

<h1>Climate listing view</h1>

<section tal:define="ctgr python:view.ctgr">

<div class="row">
    <div class="com-md-12">
        <h3>事件分類編輯</h3>
        <form tal:attributes="action context/absolute_url" method="get">
        <textarea id="category-edit" name="category-edit" class="textarea-widget list-field"
                  tal:content="view/getCtgr_text"></textarea>
        <p></p>
        <input id="category-submit" name="category-submit" class="context" value="save" type="submit">
        <a tal:attributes="href context/absolute_url" class="standalone">Default Category</a>
        </form>
    </div>
</div>

<hr>

<div class="row">
<div class="col-sm-4">
  <p class="col-sm-12" style="margin:20px 0 50px 0">
    <input type="hidden" id="year-selector" value="2000" /> 
  </p>

  <p class="col-sm-12"> 
    <input type="checkbox" name="click_all" id="click_all" value="all" />
    <span>全選/全不選</span>
  </p>

<tal:group define="sortedCtgr python:ctgr.keys();
                   tmp python:sortedCtgr.sort()">

  <p tal:repeat="group sortedCtgr" class="col-sm-6 col-xs-4">
    <input tal:define="code python:group.strip().split(':')[0]"
           tal:attributes="name code;id code; value code"
           type="checkbox" class='click_group'/>
    <span tal:content="python:group.strip().split(':')[1]">氣象</span>
  </p>

<hr>

<div style="padding-top:150px">
  <tal:group_2 repeat="group ctgr">
    <p tal:repeat="event python:ctgr[group].keys()" class="col-sm-6 col-xs-4">
      <input type="checkbox" name="event"
             tal:define="value python:event.strip().split(':')[0];
                         group python:group.split('|')[0].split(':')[0].strip()"
             tal:attributes="value value;
                             class python:'event %s' % group"/>
      <span tal:content="python:event.strip().split(':')[1]" />
    </p>
  </tal:group_2>
</div>

</tal:group>

</div>

<div class="col-sm-8">
    <div class="result">Result</div>
</div>

</div>
</section>


<script tal:attributes="src string:${portal/absolute_url}/++resource++hcd.content/jquery.range.js"></script>
<script>

// select all , cancle
$("#click_all").click(function() {
   if($("#click_all").prop("checked")) {
     $("input[name='event']").prop("checked", true);
     $("input[class='click_group']").prop("checked", true);
   } else {
     $("input[name='event']").prop("checked", false);
     $("input[class='click_group']").prop("checked", false);
   }
});

// select group_* and cancle
$(".click_group").click(function() {
   var tag_id = this.id;
   if($("#" + tag_id).prop("checked")) {
     $("input[class='event group_" + tag_id.substr(-1) + "']").prop("checked", true);
   } else {
     $("input[class='event group_" + tag_id.substr(-1) + "']").prop("checked", false);
     $("input[name='click_all']").prop("checked", false);
   }
});

// function(), ajax for getClimate
var getClimate = function(){
    var event = $("input.event:checked");
    var para = '';
    var yearRange = $('#year-selector')[0]['value'];
    for(var i=0; i<event.length; i++) {
        para += "para:list=" + event[i].value + "&";
    };
    para += 'yearRange=' + yearRange
//    console.log(para);
//    console.log($('#year-selector')[0]['value']);
    $("div.result").load("./@@get_climate?" + para);
};

// when checkbox checked.
$(':checkbox').change(function() {
    getClimate();
});

// Range bar using jquery.range.js
$('#year-selector').jRange({
    from: 0,
    to: 2000,
    step: 1,
    scale: [0,500,1000,1500,2000],
    format: '%s',
    width: 300,
    showLabels: true,
    isRange : true,
    ondragend: function(){
        getClimate();
    },
    onbarclicked: function(){
        getClimate();
    },
});

</script>

</metal:content-core>
</metal:content-core>

</body>
</html>

